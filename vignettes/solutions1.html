<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">

<head>

<meta charset="utf-8" />
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta name="generator" content="pandoc" />

<meta name="viewport" content="width=device-width, initial-scale=1">

<meta name="author" content="Jumping Rivers" />


<title>Solutions 1</title>



<style type="text/css">code{white-space: pre;}</style>
<style type="text/css">
div.sourceCode { overflow-x: auto; }
table.sourceCode, tr.sourceCode, td.lineNumbers, td.sourceCode {
  margin: 0; padding: 0; vertical-align: baseline; border: none; }
table.sourceCode { width: 100%; line-height: 100%; }
td.lineNumbers { text-align: right; padding-right: 4px; padding-left: 4px; color: #aaaaaa; border-right: 1px solid #aaaaaa; }
td.sourceCode { padding-left: 5px; }
code > span.kw { color: #007020; font-weight: bold; } /* Keyword */
code > span.dt { color: #902000; } /* DataType */
code > span.dv { color: #40a070; } /* DecVal */
code > span.bn { color: #40a070; } /* BaseN */
code > span.fl { color: #40a070; } /* Float */
code > span.ch { color: #4070a0; } /* Char */
code > span.st { color: #4070a0; } /* String */
code > span.co { color: #60a0b0; font-style: italic; } /* Comment */
code > span.ot { color: #007020; } /* Other */
code > span.al { color: #ff0000; font-weight: bold; } /* Alert */
code > span.fu { color: #06287e; } /* Function */
code > span.er { color: #ff0000; font-weight: bold; } /* Error */
code > span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
code > span.cn { color: #880000; } /* Constant */
code > span.sc { color: #4070a0; } /* SpecialChar */
code > span.vs { color: #4070a0; } /* VerbatimString */
code > span.ss { color: #bb6688; } /* SpecialString */
code > span.im { } /* Import */
code > span.va { color: #19177c; } /* Variable */
code > span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code > span.op { color: #666666; } /* Operator */
code > span.bu { } /* BuiltIn */
code > span.ex { } /* Extension */
code > span.pp { color: #bc7a00; } /* Preprocessor */
code > span.at { color: #7d9029; } /* Attribute */
code > span.do { color: #ba2121; font-style: italic; } /* Documentation */
code > span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code > span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code > span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
</style>



<link href="data:text/css;charset=utf-8,body%20%7B%0Abackground%2Dcolor%3A%20%23fff%3B%0Amargin%3A%201em%20auto%3B%0Amax%2Dwidth%3A%20700px%3B%0Aoverflow%3A%20visible%3B%0Apadding%2Dleft%3A%202em%3B%0Apadding%2Dright%3A%202em%3B%0Afont%2Dfamily%3A%20%22Open%20Sans%22%2C%20%22Helvetica%20Neue%22%2C%20Helvetica%2C%20Arial%2C%20sans%2Dserif%3B%0Afont%2Dsize%3A%2014px%3B%0Aline%2Dheight%3A%201%2E35%3B%0A%7D%0A%23header%20%7B%0Atext%2Dalign%3A%20center%3B%0A%7D%0A%23TOC%20%7B%0Aclear%3A%20both%3B%0Amargin%3A%200%200%2010px%2010px%3B%0Apadding%3A%204px%3B%0Awidth%3A%20400px%3B%0Aborder%3A%201px%20solid%20%23CCCCCC%3B%0Aborder%2Dradius%3A%205px%3B%0Abackground%2Dcolor%3A%20%23f6f6f6%3B%0Afont%2Dsize%3A%2013px%3B%0Aline%2Dheight%3A%201%2E3%3B%0A%7D%0A%23TOC%20%2Etoctitle%20%7B%0Afont%2Dweight%3A%20bold%3B%0Afont%2Dsize%3A%2015px%3B%0Amargin%2Dleft%3A%205px%3B%0A%7D%0A%23TOC%20ul%20%7B%0Apadding%2Dleft%3A%2040px%3B%0Amargin%2Dleft%3A%20%2D1%2E5em%3B%0Amargin%2Dtop%3A%205px%3B%0Amargin%2Dbottom%3A%205px%3B%0A%7D%0A%23TOC%20ul%20ul%20%7B%0Amargin%2Dleft%3A%20%2D2em%3B%0A%7D%0A%23TOC%20li%20%7B%0Aline%2Dheight%3A%2016px%3B%0A%7D%0Atable%20%7B%0Amargin%3A%201em%20auto%3B%0Aborder%2Dwidth%3A%201px%3B%0Aborder%2Dcolor%3A%20%23DDDDDD%3B%0Aborder%2Dstyle%3A%20outset%3B%0Aborder%2Dcollapse%3A%20collapse%3B%0A%7D%0Atable%20th%20%7B%0Aborder%2Dwidth%3A%202px%3B%0Apadding%3A%205px%3B%0Aborder%2Dstyle%3A%20inset%3B%0A%7D%0Atable%20td%20%7B%0Aborder%2Dwidth%3A%201px%3B%0Aborder%2Dstyle%3A%20inset%3B%0Aline%2Dheight%3A%2018px%3B%0Apadding%3A%205px%205px%3B%0A%7D%0Atable%2C%20table%20th%2C%20table%20td%20%7B%0Aborder%2Dleft%2Dstyle%3A%20none%3B%0Aborder%2Dright%2Dstyle%3A%20none%3B%0A%7D%0Atable%20thead%2C%20table%20tr%2Eeven%20%7B%0Abackground%2Dcolor%3A%20%23f7f7f7%3B%0A%7D%0Ap%20%7B%0Amargin%3A%200%2E5em%200%3B%0A%7D%0Ablockquote%20%7B%0Abackground%2Dcolor%3A%20%23f6f6f6%3B%0Apadding%3A%200%2E25em%200%2E75em%3B%0A%7D%0Ahr%20%7B%0Aborder%2Dstyle%3A%20solid%3B%0Aborder%3A%20none%3B%0Aborder%2Dtop%3A%201px%20solid%20%23777%3B%0Amargin%3A%2028px%200%3B%0A%7D%0Adl%20%7B%0Amargin%2Dleft%3A%200%3B%0A%7D%0Adl%20dd%20%7B%0Amargin%2Dbottom%3A%2013px%3B%0Amargin%2Dleft%3A%2013px%3B%0A%7D%0Adl%20dt%20%7B%0Afont%2Dweight%3A%20bold%3B%0A%7D%0Aul%20%7B%0Amargin%2Dtop%3A%200%3B%0A%7D%0Aul%20li%20%7B%0Alist%2Dstyle%3A%20circle%20outside%3B%0A%7D%0Aul%20ul%20%7B%0Amargin%2Dbottom%3A%200%3B%0A%7D%0Apre%2C%20code%20%7B%0Abackground%2Dcolor%3A%20%23f7f7f7%3B%0Aborder%2Dradius%3A%203px%3B%0Acolor%3A%20%23333%3B%0Awhite%2Dspace%3A%20pre%2Dwrap%3B%20%0A%7D%0Apre%20%7B%0Aborder%2Dradius%3A%203px%3B%0Amargin%3A%205px%200px%2010px%200px%3B%0Apadding%3A%2010px%3B%0A%7D%0Apre%3Anot%28%5Bclass%5D%29%20%7B%0Abackground%2Dcolor%3A%20%23f7f7f7%3B%0A%7D%0Acode%20%7B%0Afont%2Dfamily%3A%20Consolas%2C%20Monaco%2C%20%27Courier%20New%27%2C%20monospace%3B%0Afont%2Dsize%3A%2085%25%3B%0A%7D%0Ap%20%3E%20code%2C%20li%20%3E%20code%20%7B%0Apadding%3A%202px%200px%3B%0A%7D%0Adiv%2Efigure%20%7B%0Atext%2Dalign%3A%20center%3B%0A%7D%0Aimg%20%7B%0Abackground%2Dcolor%3A%20%23FFFFFF%3B%0Apadding%3A%202px%3B%0Aborder%3A%201px%20solid%20%23DDDDDD%3B%0Aborder%2Dradius%3A%203px%3B%0Aborder%3A%201px%20solid%20%23CCCCCC%3B%0Amargin%3A%200%205px%3B%0A%7D%0Ah1%20%7B%0Amargin%2Dtop%3A%200%3B%0Afont%2Dsize%3A%2035px%3B%0Aline%2Dheight%3A%2040px%3B%0A%7D%0Ah2%20%7B%0Aborder%2Dbottom%3A%204px%20solid%20%23f7f7f7%3B%0Apadding%2Dtop%3A%2010px%3B%0Apadding%2Dbottom%3A%202px%3B%0Afont%2Dsize%3A%20145%25%3B%0A%7D%0Ah3%20%7B%0Aborder%2Dbottom%3A%202px%20solid%20%23f7f7f7%3B%0Apadding%2Dtop%3A%2010px%3B%0Afont%2Dsize%3A%20120%25%3B%0A%7D%0Ah4%20%7B%0Aborder%2Dbottom%3A%201px%20solid%20%23f7f7f7%3B%0Amargin%2Dleft%3A%208px%3B%0Afont%2Dsize%3A%20105%25%3B%0A%7D%0Ah5%2C%20h6%20%7B%0Aborder%2Dbottom%3A%201px%20solid%20%23ccc%3B%0Afont%2Dsize%3A%20105%25%3B%0A%7D%0Aa%20%7B%0Acolor%3A%20%230033dd%3B%0Atext%2Ddecoration%3A%20none%3B%0A%7D%0Aa%3Ahover%20%7B%0Acolor%3A%20%236666ff%3B%20%7D%0Aa%3Avisited%20%7B%0Acolor%3A%20%23800080%3B%20%7D%0Aa%3Avisited%3Ahover%20%7B%0Acolor%3A%20%23BB00BB%3B%20%7D%0Aa%5Bhref%5E%3D%22http%3A%22%5D%20%7B%0Atext%2Ddecoration%3A%20underline%3B%20%7D%0Aa%5Bhref%5E%3D%22https%3A%22%5D%20%7B%0Atext%2Ddecoration%3A%20underline%3B%20%7D%0A%0Acode%20%3E%20span%2Ekw%20%7B%20color%3A%20%23555%3B%20font%2Dweight%3A%20bold%3B%20%7D%20%0Acode%20%3E%20span%2Edt%20%7B%20color%3A%20%23902000%3B%20%7D%20%0Acode%20%3E%20span%2Edv%20%7B%20color%3A%20%2340a070%3B%20%7D%20%0Acode%20%3E%20span%2Ebn%20%7B%20color%3A%20%23d14%3B%20%7D%20%0Acode%20%3E%20span%2Efl%20%7B%20color%3A%20%23d14%3B%20%7D%20%0Acode%20%3E%20span%2Ech%20%7B%20color%3A%20%23d14%3B%20%7D%20%0Acode%20%3E%20span%2Est%20%7B%20color%3A%20%23d14%3B%20%7D%20%0Acode%20%3E%20span%2Eco%20%7B%20color%3A%20%23888888%3B%20font%2Dstyle%3A%20italic%3B%20%7D%20%0Acode%20%3E%20span%2Eot%20%7B%20color%3A%20%23007020%3B%20%7D%20%0Acode%20%3E%20span%2Eal%20%7B%20color%3A%20%23ff0000%3B%20font%2Dweight%3A%20bold%3B%20%7D%20%0Acode%20%3E%20span%2Efu%20%7B%20color%3A%20%23900%3B%20font%2Dweight%3A%20bold%3B%20%7D%20%20code%20%3E%20span%2Eer%20%7B%20color%3A%20%23a61717%3B%20background%2Dcolor%3A%20%23e3d2d2%3B%20%7D%20%0A" rel="stylesheet" type="text/css" />

</head>

<body>




<h1 class="title toc-ignore">Solutions 1</h1>
<h4 class="author"><em>Jumping Rivers</em></h4>



<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># knitr::opts_chunk$set(results = &quot;hide&quot;, echo = FALSE)</span></code></pre></div>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(knitr)
<span class="co"># opts_knit$set(out.format = &quot;latex&quot;)</span>
knit_theme<span class="op">$</span><span class="kw">set</span>(knit_theme<span class="op">$</span><span class="kw">get</span>(<span class="st">&quot;greyscale0&quot;</span>))

<span class="kw">options</span>(<span class="dt">replace.assign=</span><span class="ot">FALSE</span>,<span class="dt">width=</span><span class="dv">50</span>)

opts_chunk<span class="op">$</span><span class="kw">set</span>(<span class="dt">fig.path=</span><span class="st">'figure/graphics-'</span>, 
               <span class="dt">cache.path=</span><span class="st">'cache/graphics-'</span>, 
               <span class="dt">fig.align=</span><span class="st">'center'</span>, 
               <span class="dt">dev=</span><span class="st">'pdf'</span>, <span class="dt">fig.width=</span><span class="dv">5</span>, <span class="dt">fig.height=</span><span class="dv">5</span>, 
               <span class="dt">fig.show=</span><span class="st">'hold'</span>, <span class="dt">cache=</span><span class="ot">FALSE</span>, <span class="dt">par=</span><span class="ot">TRUE</span>)
knit_hooks<span class="op">$</span><span class="kw">set</span>(<span class="dt">crop=</span>hook_pdfcrop)</code></pre></div>
<div id="a-new-table" class="section level2">
<h2>A new table</h2>
<p>To begin this practical we will add some data to our database. The table below gives some data on different cars and their fuel economy.</p>
<pre class="results"><code>suppressPackageStartupMessages(library(dplyr))
set.seed(1)
data(&quot;FuelEconomy&quot;,package = &quot;jRsql&quot;)
df = cars2010 %&gt;% sample_n(6) %&gt;% select(EngDispl, NumCyl, Transmission, FE) 
df[6,1] = 7
df %&gt;%
  knitr::kable(format = &quot;html&quot;)</code></pre>
<p>To create your connection to the database</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(RPostgreSQL)
drv =<span class="st"> </span><span class="kw">dbDriver</span>(<span class="st">&quot;PostgreSQL&quot;</span>)
<span class="co"># everyones user name and password is different</span>
<span class="co"># database name is the same as your user name</span>
con =<span class="st"> </span><span class="kw">dbConnect</span>(drv, <span class="dt">user =</span> <span class="st">&quot;user.name&quot;</span>, <span class="dt">password =</span> <span class="st">&quot;user.password&quot;</span>, <span class="dt">dbname =</span> <span class="st">&quot;user.dbname&quot;</span>)</code></pre></div>
<ol style="list-style-type: decimal">
<li><p>Create a new table called “fuel_economy” in your database with the appropriate variable types for the columns. Note that NumCyl should be an integer.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">statement =<span class="st"> &quot;</span>
<span class="st">CREATE TABLE fuel_economy (</span>
<span class="st">  EngDispl double precision,</span>
<span class="st">  NumCyl integer, </span>
<span class="st">  Transmission text,</span>
<span class="st">  FE double precision</span>
<span class="st">);</span>
<span class="st">&quot;</span>
<span class="kw">dbExecute</span>(con, statement)</code></pre></div></li>
<li><p>Populate your new table with the data. (Remeber <code>INSERT INTO</code> and <code>VALUES</code>)</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">statement =<span class="st"> &quot;</span>
<span class="st">INSERT INTO fuel_economy (EngDispl, NumCyl, Transmission, FE)</span>
<span class="st">  VALUES </span>
<span class="st">  (2.0, 4, 'M5', 46.4387),</span>
<span class="st">  (3.6, 6, 'S6', 40.0000),</span>
<span class="st">  (2.5, 4, 'S4', 32.9103),</span>
<span class="st">  (5.7, 8, 'A5', 26.0000),</span>
<span class="st">  (1.8, 4, 'A4', 47.2000),</span>
<span class="st">  (7.0, 6, 'A6', 36.0000);</span>
<span class="st">&quot;</span>
<span class="kw">dbExecute</span>(con, statement)</code></pre></div></li>
<li><p>Unfortunately the displacement value is wrong for the last car in the data set here. We should change the 7.0 to a 3.5. Use <code>UPDATE</code> and <code>SET</code> to amend the data.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">statement =<span class="st"> &quot;</span>
<span class="st">UPDATE fuel_economy</span>
<span class="st">  SET EngDispl = 3.5 </span>
<span class="st">  WHERE EngDispl = 7.0;</span>
<span class="st">&quot;</span>
<span class="kw">dbExecute</span>(con, statement)</code></pre></div></li>
<li><p>Add a new text column called “gearbox”, we will use this to have nicer labels for the transmission variable.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">statement =<span class="st"> &quot;</span>
<span class="st">ALTER TABLE fuel_economy</span>
<span class="st">  ADD COLUMN gearbox text;</span>
<span class="st">&quot;</span>
<span class="kw">dbExecute</span>(con, statement)</code></pre></div></li>
</ol>
</div>
<div id="something-new" class="section level2">
<h2>Something new</h2>
<p>We haven’t spoken about SQL transaction during the lectures. Essentially a transaction is a collection of SQL clauses that we want to either all happen, or none happen. Essentially we want to create a guarantee that the table modification can’t partially complete. Imagine the simple scenario of a bank monitoring balances of it’s customers. Let’s say Alice wants to pay Ben £100. In our hypothetical scenario we could use the following code to update the data table.</p>
<div class="sourceCode"><pre class="sourceCode sql"><code class="sourceCode sql"><span class="kw">UPDATE</span> balances
  <span class="kw">SET</span> amount = amount - <span class="dv">100</span>
  <span class="kw">WHERE</span> customer = <span class="st">'Alice'</span>;
<span class="kw">UPDATE</span> balances
  <span class="kw">SET</span> amount = amount + <span class="dv">100</span>
  <span class="kw">WHERE</span> customer = <span class="st">'Ben'</span>;</code></pre></div>
<p>That is we make two modifications, one that subtracts the balance from Alice and a second which credits it to Ben. The bank manager will want a guarantee that either both of these modifications have been made, or none of them have. They certainly wouldn’t be happy if Ben was credited £100 without subtracting it from Alice. Likewise Alice would be very upset if she spent £100 but Ben never received it. A transaction gives us a guarantee that if something goes wrong part way through the sequence of statements (perhaps someone else is modifying the database at the same time) that none of the data has been changed.</p>
<p>In PostgreSQL we can create our transaction by surrounding our statements with <code>BEGIN</code> and <code>COMMIT</code></p>
<div class="sourceCode"><pre class="sourceCode sql"><code class="sourceCode sql"><span class="kw">BEGIN</span>;
<span class="kw">UPDATE</span> balances
  <span class="kw">SET</span> amount = amount - <span class="dv">100</span>
  <span class="kw">WHERE</span> customer = <span class="st">'Alice'</span>;
<span class="kw">UPDATE</span> balances
  <span class="kw">SET</span> amount = amount + <span class="dv">100</span>
  <span class="kw">WHERE</span> customer = <span class="st">'Ben'</span>;
<span class="kw">COMMIT</span>;</code></pre></div>
<p>The <code>DBI</code> R package also provides a useful function for this</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">dbWithTransaction</span>(
  con, 
  {
    <span class="kw">dbExecute</span>(con, <span class="st">&quot;UPDATE balances SET amount = amount - 100 WHERE customer = 'Alice';&quot;</span>)
    <span class="kw">dbExecute</span>(con, <span class="st">&quot;UPDATE balances SET amount = amount + 100 WHERE customer = 'Ben';&quot;</span>)
  }
)</code></pre></div>
<ol style="list-style-type: decimal">
<li>Try using a transaction to update the “gearbox” column you added to your table based on the values of “Transmission”.
<ul>
<li>Whenever transmission starts with an “M” give gearbox the value “manual”</li>
<li>When it starts with “S” give “sequential”</li>
<li>When it starts = “A” give “automatic”</li>
</ul>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">statement =<span class="st"> &quot;</span>
<span class="st">BEGIN;</span>
<span class="st">UPDATE fuel_economy</span>
<span class="st">  SET gearbox = 'manual'</span>
<span class="st">  WHERE transmission LIKE 'M%';</span>
<span class="st">UPDATE fuel_economy</span>
<span class="st">  SET gearbox = 'sequential'</span>
<span class="st">  WHERE transmission LIKE 'S%';</span>
<span class="st">UPDATE fuel_economy</span>
<span class="st">  SET gearbox = 'automatic'</span>
<span class="st">  WHERE transmission LIKE 'A%';</span>
<span class="st">COMMIT;</span>
<span class="st">&quot;</span>
<span class="kw">dbExecute</span>(con, statement)</code></pre></div></li>
</ol>
</div>
<div id="the-full-cars-data" class="section level2">
<h2>The full cars data</h2>
<p>The full cars data set from which the above subset is taken is part of the course package and can be loaded with</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">data</span>(<span class="st">&quot;FuelEconomy&quot;</span>, <span class="dt">package =</span> <span class="st">&quot;jRsql&quot;</span>)</code></pre></div>
<p>We can copy this data into the database with, to make life easier for ourselves we will turn the column names to all lower case first</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">colnames</span>(cars2010) =<span class="st"> </span><span class="kw">tolower</span>(<span class="kw">colnames</span>(cars2010))
<span class="kw">dbWriteTable</span>(con, <span class="dt">name =</span> <span class="st">&quot;cars&quot;</span>, cars2010)</code></pre></div>
<p>The remaining questions concern this data, solutions should be obtained using SQL queries, no cheating with pure R code.</p>
<ol style="list-style-type: decimal">
<li><p>How many cars are there with <code>engdispl &gt;= 3.0</code>?</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">query =<span class="st"> &quot;</span>
<span class="st">SELECT * FROM cars</span>
<span class="st">  WHERE engdispl &gt;= 3.0;</span>
<span class="st">&quot;</span>
df =<span class="st"> </span><span class="kw">dbGetQuery</span>(con,query)
<span class="kw">nrow</span>(df)
<span class="co"># 695</span></code></pre></div></li>
<li><p>What is the most efficient car (highest value of fe)?</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">query =<span class="st"> &quot;</span>
<span class="st">SELECT fe FROM cars</span>
<span class="st">  ORDER BY fe DESC</span>
<span class="st">  LIMIT 1;</span>
<span class="st">&quot;</span>
<span class="kw">dbGetQuery</span>(con,query)
<span class="co"># 69.6404</span></code></pre></div></li>
<li><p>How many different types of transmission are there?</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">query =<span class="st"> &quot;</span>
<span class="st">SELECT DISTINCT transmission FROM cars;</span>
<span class="st">&quot;</span>
<span class="kw">dbGetQuery</span>(con,query)
<span class="co"># 16</span></code></pre></div></li>
</ol>
</div>



<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>

</body>
</html>
